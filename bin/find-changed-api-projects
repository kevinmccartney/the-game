#!/usr/bin/env python

import subprocess
import os
import json

changed_projects = []

api_projects_env_var = os.environ.get("THE_GAME_API_PROJECTS")
api_projects = api_projects_env_var.split(",")

diff = subprocess.run(
    ["git", "diff", "--name-only", "HEAD", "HEAD~1"],
    stdout=subprocess.PIPE,
    text=True,
)

changes = diff.stdout.splitlines()

for project in api_projects:
    res = [i for i in changes if project in i]

    if len(res) > 0:
        changed_projects.append(project)

print("Changed Projects:")

if len(changed_projects) > 0:
    print(changed_projects)
    with open("the-game-changed-api-projects.json", "w") as file:
        file.write(json.dumps({"changes": changed_projects}))
else:
    print("No changes")
    with open("the-game-changed-api-projects.json", "w") as file:
        # file.write(json.dumps({"changes": ["__no-changes"]}))
        file.write(json.dumps({"changes": []}))
